!function(a,b){function e(b){return b instanceof a?b:a(b)}var d,c=this;d=c.SirTrevor={},d.DEBUG=!1,d.SKIP_VALIDATION=!1,d.version="0.3.0",d.LANGUAGE="en",d.DEFAULTS={defaultType:!1,spinner:{className:"st-spinner",lines:9,length:8,width:3,radius:6,color:"#000",speed:1.4,trail:57,shadow:!1,left:"50%",top:"50%"},blockLimit:0,blockTypeLimits:{},required:[],uploadUrl:"/attachments",baseImageUrl:"/sir-trevor-uploads/",errorsContainer:void 0,toMarkdown:{aggresiveHTMLStrip:!1}},d.BlockMixins={},d.Blocks={},d.Formatters={},d.instances=[],d.Events=Eventable;var f=!1,g={bound:[],_bindFunctions:function(){this.bound.length>0&&b.bindAll.apply(null,b.union([this],this.bound))}},h={tagName:"div",className:"sir-trevor__view",attributes:{},$:function(a){return this.$el.find(a)},render:function(){return this},destroy:function(){b.isUndefined(this.stopListening)||this.stopListening(),this.$el.remove()},_ensureElement:function(){if(this.el)this._setElement(this.el);else{var d,c=b.extend({},b.result(this,"attributes"));this.id&&(c.id=this.id),this.className&&(c["class"]=this.className),c.html&&(d=c.html,delete c.html);var e=a("<"+this.tagName+">").attr(c);d&&e.html(d),this._setElement(e)}},_setElement:function(a){return this.$el=e(a),this.el=this.$el[0],this}};!function(a){function b(a){a.preventDefault()}function c(b){b.originalEvent.dataTransfer.dropEffect="copy",a(b.currentTarget).addClass("st-drag-over"),b.preventDefault()}function d(b){a(b.currentTarget).removeClass("st-drag-over"),b.preventDefault()}a.fn.dropArea=function(){return this.bind("dragenter",b).bind("dragover",c).bind("dragleave",d),this},a.fn.noDropArea=function(){return this.unbind("dragenter").unbind("dragover").unbind("dragleave"),this},a.fn.caretToEnd=function(){var a,b;return a=document.createRange(),a.selectNodeContents(this[0]),a.collapse(!1),b=window.getSelection(),b.removeAllRanges(),b.addRange(a),this}}(jQuery);var j=function(a,c){var e,d=this;e=a&&b.has(a,"constructor")?a.constructor:function(){return d.apply(this,arguments)},b.extend(e,d,c);var f=function(){this.constructor=e};return f.prototype=d.prototype,e.prototype=new f,a&&b.extend(e.prototype,a),e.__super__=d.prototype,e};d.log=function(a){!b.isUndefined(console)&&d.DEBUG&&console.log(a)},d.Locales={en:{general:{"delete":"Delete?",drop:"Drag __block__ here",paste:"Or paste URL here",upload:"...or choose a file",close:"close",position:"Position",wait:"Please wait...",link:"Enter a link"},errors:{title:"You have the following errors:",validation_fail:"__type__ block is invalid",block_empty:"__name__ must not be empty",type_missing:"You must have a block of type __type__",required_type_empty:"A required block type __type__ is empty",load_fail:"There was a problem loading the contents of the document"},blocks:{text:{title:"Text"},list:{title:"List"},quote:{title:"Quote",credit_field:"Credit"},image:{title:"Image",upload_error:"There was a problem with your upload"},video:{title:"Video"},tweet:{title:"Tweet",fetch_error:"There was a problem fetching your tweet"},embedly:{title:"Embedly",fetch_error:"There was a problem fetching your embed",key_missing:"An Embedly API key must be present"},heading:{title:"Heading"}}}},void 0===window.i18n||void 0===window.i18n.init?(d.log("Using i18n stub"),window.i18n={t:function(a,c){var f,g,h,i,e=a.split(":");for(g=d.Locales[d.LANGUAGE],i=0;i<e.length;i++)h=e[i],b.isUndefined(g[h])||(g=g[h]);return f=g,b.isString(f)?(f.indexOf("__")>=0&&b.each(c,function(a,b){f=f.replace("__"+b+"__",a)}),f):""}}):(d.log("Using i18next"),i18n.init({resStore:d.Locales,fallbackLng:d.LANGUAGE,ns:{namespaces:["general","blocks"],defaultNs:"general"}})),function(a,b,c){function d(a,c){var e,d=b.createElement(a||"div");for(e in c)d[e]=c[e];return d}function e(a){for(var b=1,c=arguments.length;c>b;b++)a.appendChild(arguments[b]);return a}function f(a,b,c,d){var e=["opacity",b,~~(100*a),c,d].join("-"),f=.01+100*(c/d),g=Math.max(1-(1-a)/b*(100-f),a),h=m.substring(0,m.indexOf("Animation")).toLowerCase(),i=h&&"-"+h+"-"||"";return l[e]||(n.insertRule("@"+i+"keyframes "+e+"{"+"0%{opacity:"+g+"}"+f+"%{opacity:"+a+"}"+(f+.01)+"%{opacity:1}"+(f+b)%100+"%{opacity:"+a+"}"+"100%{opacity:"+g+"}"+"}",0),l[e]=1),e}function g(a,b){var e,f,d=a.style;if(d[b]!==c)return b;for(b=b.charAt(0).toUpperCase()+b.slice(1),f=0;f<k.length;f++)if(e=k[f]+b,d[e]!==c)return e}function h(a,b){for(var c in b)a.style[g(a,c)||c]=b[c];return a}function i(a){for(var b=1;b<arguments.length;b++){var d=arguments[b];for(var e in d)a[e]===c&&(a[e]=d[e])}return a}function j(a){for(var b={x:a.offsetLeft,y:a.offsetTop};a=a.offsetParent;)b.x+=a.offsetLeft,b.y+=a.offsetTop;return b}var m,k=["webkit","Moz","ms","O"],l={},n=function(){var a=d("style");return e(b.getElementsByTagName("head")[0],a),a.sheet||a.styleSheet}(),o={lines:12,length:7,width:5,radius:10,rotate:0,color:"#000",speed:1,trail:100,opacity:.25,fps:20,zIndex:2e9,className:"spinner",top:"auto",left:"auto"},p=function q(a){return this.spin?(this.opts=i(a||{},q.defaults,o),void 0):new q(a)};p.defaults={},i(p.prototype,{spin:function(a){this.stop();var g,i,b=this,c=b.opts,e=b.el=h(d(0,{className:c.className}),{position:"relative",zIndex:c.zIndex}),f=c.radius+c.length+c.width;if(a&&(a.insertBefore(e,a.firstChild||null),i=j(a),g=j(e),h(e,{left:("auto"==c.left?i.x-g.x+(a.offsetWidth>>1):c.left+f)+"px",top:("auto"==c.top?i.y-g.y+(a.offsetHeight>>1):c.top+f)+"px"})),e.setAttribute("aria-role","progressbar"),b.lines(e,b.opts),!m){var k=0,l=c.fps,n=l/c.speed,o=(1-c.opacity)/(n*c.trail/100),p=n/c.lines;!function q(){k++;for(var a=c.lines;a;a--){var d=Math.max(1-(k+a*p)%n*o,c.opacity);b.opacity(e,c.lines-a,d,c)}b.timeout=b.el&&setTimeout(q,~~(1e3/l))}()}return b},stop:function(){var a=this.el;return a&&(clearTimeout(this.timeout),a.parentNode&&a.parentNode.removeChild(a),this.el=c),this},lines:function(a,b){function c(a,c){return h(d(),{position:"absolute",width:b.length+b.width+"px",height:b.width+"px",background:a,boxShadow:c,transformOrigin:"left",transform:"rotate("+~~(360/b.lines*g+b.rotate)+"deg) translate("+b.radius+"px"+",0)",borderRadius:(b.width>>1)+"px"})}for(var i,g=0;g<b.lines;g++)i=h(d(),{position:"absolute",top:1+~(b.width/2)+"px",transform:b.hwaccel?"translate3d(0,0,0)":"",opacity:b.opacity,animation:m&&f(b.opacity,b.trail,g,b.lines)+" "+1/b.speed+"s linear infinite"}),b.shadow&&e(i,h(c("#000","0 0 4px #000"),{top:"2px"})),e(a,e(i,c(b.color,"0 0 1px rgba(0,0,0,.1)")));return a},opacity:function(a,b,c){b<a.childNodes.length&&(a.childNodes[b].style.opacity=c)}}),!function(){function a(a,b){return d("<"+a+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',b)}var b=h(d("group"),{behavior:"url(#default#VML)"});!g(b,"transform")&&b.adj?(n.addRule(".spin-vml","behavior:url(#default#VML)"),p.prototype.lines=function(b,c){function d(){return h(a("group",{coordsize:i+" "+i,coordorigin:-g+" "+-g}),{width:i,height:i})}function f(b,f,i){e(k,e(h(d(),{rotation:360/c.lines*b+"deg",left:~~f}),e(h(a("roundrect",{arcsize:1}),{width:g,height:c.width,left:c.radius,top:-c.width>>1,filter:i}),a("fill",{color:c.color,opacity:c.opacity}),a("stroke",{opacity:0}))))}var l,g=c.length+c.width,i=2*g,j=2*-(c.width+c.length)+"px",k=h(d(),{position:"absolute",top:j,left:j});if(c.shadow)for(l=1;l<=c.lines;l++)f(l,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");for(l=1;l<=c.lines;l++)f(l);return e(b,k)},p.prototype.opacity=function(a,b,c,d){var e=a.firstChild;d=d.shadow&&d.lines||0,e&&b+d<e.childNodes.length&&(e=e.childNodes[b+d],e=e&&e.firstChild,e=e&&e.firstChild,e&&(e.opacity=c))}):m=g(b,"animation")}(),a.Spinner=p}(window,document),d.editorStore=function(a,c,e){var f;switch(e=e||{},c){case"create":var g=b.trim(a.$el.val());if(a.dataStore={data:[]},g.length>0)try{var h=JSON.parse(g);b.isUndefined(h.data)||(a.dataStore=h)}catch(i){a.errors.push({text:i18n.t("errors:load_fail")}),a.renderErrors(),d.log("Sorry there has been a problem with parsing the JSON"),d.log(i)}break;case"reset":a.dataStore={data:[]};break;case"add":e.data&&(a.dataStore.data.push(e.data),f=a.dataStore);break;case"save":a.$el.val(a.dataStore.data.length>0?JSON.stringify(a.dataStore):"");break;case"read":f=a.dataStore}return f?f:void 0},d.Submittable=function(a){this.$form=a,this.intialize()},b.extend(d.Submittable.prototype,{intialize:function(){this.$submitBtn=this.$form.find("input[type='submit']");var c=[];b.each(this.$submitBtn,function(b){c.push(a(b).attr("value"))}),this.submitBtnTitles=c,this.canSubmit=!0,this.globalUploadCount=0,this._bindEvents()},setSubmitButton:function(a,b){this.$submitBtn.attr("value",b)},resetSubmitButton:function(){b.each(this.$submitBtn,function(b,c){a(b).attr("value",this.submitBtnTitles[c])},this)},onUploadStart:function(){this.globalUploadCount++,d.log("onUploadStart called "+this.globalUploadCount),1===this.globalUploadCount&&this._disableSubmitButton()},onUploadStop:function(){this.globalUploadCount=this.globalUploadCount<=0?0:this.globalUploadCount-1,d.log("onUploadStop called "+this.globalUploadCount),0===this.globalUploadCount&&this._enableSubmitButton()},onError:function(){d.log("onError called"),this.canSubmit=!1},_disableSubmitButton:function(a){this.setSubmitButton(null,a||i18n.t("general:wait")),this.$submitBtn.attr("disabled","disabled").addClass("disabled")},_enableSubmitButton:function(){this.resetSubmitButton(),this.$submitBtn.removeAttr("disabled").removeClass("disabled")},_events:{disableSubmitButton:"_disableSubmitButton",enableSubmitButton:"_enableSubmitButton",setSubmitButton:"setSubmitButton",resetSubmitButton:"resetSubmitButton",onError:"onError",onUploadStart:"onUploadStart",onUploadStop:"onUploadStop"},_bindEvents:function(){b.forEach(this._events,function(a,b){d.EventBus.on(b,this[a],this)},this)}}),d.fileUploader=function(c,e,f,g){var h=[c.blockID,(new Date).getTime(),"raw"].join("-"),i=new FormData;i.append("attachment[name]",e.name),i.append("attachment[file]",e),i.append("attachment[uid]",h),c.resetMessages();var j=function(){d.log("Upload callback called"),!b.isUndefined(f)&&b.isFunction(f)&&f.apply(c,arguments)},k=function(){d.log("Upload callback error called"),!b.isUndefined(g)&&b.isFunction(g)&&g.apply(c,arguments)},l=a.ajax({url:d.DEFAULTS.uploadUrl,data:i,cache:!1,contentType:!1,processData:!1,dataType:"json",type:"POST"});return c.addQueuedItem(h,l),l.done(j).fail(k).always(b.bind(c.removeQueuedItem,c,h)),l};var k=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/;b.mixin({isURI:function(a){return k.test(a)},titleize:function(a){return null===a?"":(a=String(a).toLowerCase(),a.replace(/(?:^|\s|-)\S/g,function(a){return a.toUpperCase()}))},classify:function(a){return b.titleize(String(a).replace(/[\W_]/g," ")).replace(/\s/g,"")},classifyList:function(a){return b.map(a,function(a){return b.classify(a)})},capitalize:function(a){return a.charAt(0).toUpperCase()+a.substring(1).toLowerCase()},underscored:function(a){return b.trim(a).replace(/([a-z\d])([A-Z]+)/g,"$1_$2").replace(/[-\s]+/g,"_").toLowerCase()},trim:function(a){return a.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},reverse:function(a){return a.split("").reverse().join("")},flattern:function(a){var c={};return b.each(a,function(d,e){c[b.isArray(a)?d:e]=!0}),c},to_slug:function(a){return a.toLowerCase().replace(/[^\w ]+/g,"").replace(/ +/g,"-")}}),d.toHTML=function(a,c){c=b.classify(c);var e=a,f="Text"===c;b.isUndefined(f)&&(f=!1),f&&(e="<div>"+e),e=e.replace(/\[([^\]]+)\]\(([^\)]+)\)/gm,function(a,b,c){return"<a href='"+c+"'>"+b.replace(/\r?\n/g,"")+"</a>"}),e=b.reverse(b.reverse(e).replace(/_(?!\\)((_\\|[^_])*)_(?=$|[^\\])/gm,function(a,b){return">i/<"+b.replace(/\r?\n/g,"").replace(/[\s]+$/,"")+">i<"}).replace(/\*\*(?!\\)((\*\*\\|[^\*\*])*)\*\*(?=$|[^\\])/gm,function(a,b){return">b/<"+b.replace(/\r?\n/g,"").replace(/[\s]+$/,"")+">b<"})),e=e.replace(/^\> (.+)$/gm,"$1");var g,h;for(g in d.Formatters)d.Formatters.hasOwnProperty(g)&&(h=d.Formatters[g],!b.isUndefined(h.toHTML)&&b.isFunction(h.toHTML)&&(e=h.toHTML(e)));var i;return d.Blocks.hasOwnProperty(c)&&(i=d.Blocks[c],!b.isUndefined(i.prototype.toHTML)&&b.isFunction(i.prototype.toHTML)&&(e=i.prototype.toHTML(e))),f&&(e=e.replace(/\r?\n\r?\n/gm,"</div><div><br></div><div>"),e=e.replace(/\r?\n/gm,"</div><div>")),e=e.replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;").replace(/\r?\n/g,"<br>").replace(/\*\*/,"").replace(/__/,""),e=e.replace(/\\\*/g,"*").replace(/\\\[/g,"[").replace(/\\\]/g,"]").replace(/\\\_/g,"_").replace(/\\\(/g,"(").replace(/\\\)/g,")").replace(/\\\-/g,"-"),f&&(e+="</div>"),e},d.toMarkdown=function(a,c){function j(a,c,d){return b.isUndefined(d)&&(d=""),"**"+c.replace(/<(.)?br(.)?>/g,"")+"**"+d}function k(a,c,d){return b.isUndefined(d)&&(d=""),"_"+c.replace(/<(.)?br(.)?>/g,"")+"_"+d}c=b.classify(c);var e=a;e=e.replace(/&nbsp;/g," "),e=e.replace(/( class=(")?Mso[a-zA-Z]+(")?)/g,"").replace(/<!--(.*?)-->/g,"").replace(/\/\*(.*?)\*\//g,"").replace(/<(\/)*(meta|link|span|\\?xml:|st1:|o:|font)(.*?)>/gi,"");var g,h,f=["style","script","applet","embed","noframes","noscript"];for(h=0;h<f.length;h++)g=new RegExp("<"+f[h]+".*?"+f[h]+"(.*?)>","gi"),e=e.replace(g,"");e=e.replace(/\*/g,"\\*").replace(/\[/g,"\\[").replace(/\]/g,"\\]").replace(/\_/g,"\\_").replace(/\(/g,"\\(").replace(/\)/g,"\\)").replace(/\-/g,"\\-");var i=["em","i","strong","b"];for(h=0;h<i.length;h++)g=new RegExp("<"+i[h]+"><br></"+i[h]+">","gi"),e=e.replace(g,"<br>");e=e.replace(/<(\w+)(?:\s+\w+="[^"]+(?:"\$[^"]+"[^"]+)?")*>\s*<\/\1>/gim,"").replace(/\n/gm,"").replace(/<a.*?href=[""'](.*?)[""'].*?>(.*?)<\/a>/gim,function(a,b,c){return"["+c.trim().replace(/<(.)?br(.)?>/g,"")+"]("+b+")"}).replace(/<strong>(?:\s*)(.*?)(\s)*?<\/strong>/gim,j).replace(/<b>(?:\s*)(.*?)(\s*)?<\/b>/gim,j).replace(/<em>(?:\s*)(.*?)(\s*)?<\/em>/gim,k).replace(/<i>(?:\s*)(.*?)(\s*)?<\/i>/gim,k);var l,m;for(l in d.Formatters)d.Formatters.hasOwnProperty(l)&&(m=d.Formatters[l],!b.isUndefined(m.toMarkdown)&&b.isFunction(m.toMarkdown)&&(e=m.toMarkdown(e)));e=e.replace(/([^<>]+)(<div>)/g,"$1\n$2").replace(/<div><div>/g,"\n<div>").replace(/(?:<div>)([^<>]+)(?:<div>)/g,"$1\n").replace(/(?:<div>)(?:<br>)?([^<>]+)(?:<br>)?(?:<\/div>)/g,"$1\n").replace(/<\/p>/g,"\n\n").replace(/<(.)?br(.)?>/g,"\n").replace(/&lt;/g,"<").replace(/&gt;/g,">");var n;return d.Blocks.hasOwnProperty(c)&&(n=d.Blocks[c],!b.isUndefined(n.prototype.toMarkdown)&&b.isFunction(n.prototype.toMarkdown)&&(e=n.prototype.toMarkdown(e))),e=d.DEFAULTS.toMarkdown.aggresiveHTMLStrip?e.replace(/<\/?[^>]+(>|$)/g,""):e.replace(/<(?=\S)\/?[^>]+(>|$)/gi,"")},d.EventBus=b.extend({},d.Events),d.BlockMixins.Ajaxable={mixinName:"Ajaxable",ajaxable:!0,initializeAjaxable:function(){this._queued=[]},addQueuedItem:function(a,b){d.log("Adding queued item for "+this.blockID+" called "+a),d.EventBus.trigger("onUploadStart",this.blockID),this._queued.push({name:a,deferred:b})},removeQueuedItem:function(a){d.log("Removing queued item for "+this.blockID+" called "+a),d.EventBus.trigger("onUploadStop",this.blockID),this._queued=b.reject(this._queued,function(b){return b.name==a})},hasItemsInQueue:function(){return this._queued.length>0},resolveAllInQueue:function(){b.each(this._queued,function(a){d.log("Aborting queued request: "+a.name),a.deferred.abort()},this)}},d.BlockMixins.Controllable={mixinName:"Controllable",initializeControllable:function(){d.log("Adding controllable to block "+this.blockID),this.$control_ui=a("<div>",{"class":"st-block__control-ui"}),b.each(this.controls,function(a,c){this.addUiControl(c,b.bind(a,this))},this),this.$inner.append(this.$control_ui)},getControlTemplate:function(b){return a("<a>",{"data-icon":b,"class":"st-icon st-block-control-ui-btn st-block-control-ui-btn--"+b})},addUiControl:function(a,b){this.$control_ui.append(this.getControlTemplate(a)),this.$control_ui.on("click",".st-block-control-ui-btn--"+a,b)}},d.BlockMixins.Droppable={mixinName:"Droppable",valid_drop_file_types:["File","Files","text/plain","text/uri-list"],initializeDroppable:function(){d.log("Adding droppable to block "+this.blockID),this.drop_options=b.extend({},d.DEFAULTS.Block.drop_options,this.drop_options);var c=a(b.template(this.drop_options.html,{block:this}));this.$editor.hide(),this.$inputs.append(c),this.$dropzone=c,this.$dropzone.dropArea().bind("drop",b.bind(this._handleDrop,this)),this.$inner.addClass("st-block__inner--droppable")},_handleDrop:function(c){c.preventDefault(),c=c.originalEvent;var e=a(c.target),f=c.dataTransfer.types;e.removeClass("st-dropzone--dragover"),!b.isUndefined(f)&&b.some(f,function(a){return b.include(this.valid_drop_file_types,a)},this)&&this.onDrop(c.dataTransfer),d.EventBus.trigger("block:content:dropped",this.blockID)}},d.BlockMixins.Fetchable={mixinName:"Fetchable",initializeFetchable:function(){this.withMixin(d.BlockMixins.Ajaxable)},fetch:function(c,d,e){var f=b.uniqueId(this.blockID+"_fetch"),g=a.ajax(c);return this.resetMessages(),this.addQueuedItem(f,g),b.isUndefined(d)||g.done(b.bind(d,this)),b.isUndefined(e)||g.fail(b.bind(e,this)),g.always(b.bind(this.removeQueuedItem,this,f)),g}},d.BlockMixins.Pastable={mixinName:"Pastable",initializePastable:function(){d.log("Adding pastable to block "+this.blockID),this.paste_options=b.extend({},d.DEFAULTS.Block.paste_options,this.paste_options),this.$inputs.append(b.template(this.paste_options.html,this)),this.$(".st-paste-block").bind("click",function(){a(this).select()}).bind("paste",this._handleContentPaste).bind("submit",this._handleContentPaste)}},d.BlockMixins.Uploadable={mixinName:"Uploadable",uploadsCount:0,initializeUploadable:function(){d.log("Adding uploadable to block "+this.blockID),this.withMixin(d.BlockMixins.Ajaxable),this.upload_options=b.extend({},d.DEFAULTS.Block.upload_options,this.upload_options),this.$inputs.append(b.template(this.upload_options.html,this))},uploader:function(a,b,c){return d.fileUploader(this,a,b,c)}},d.BlockPositioner=function(){var a=["<div class='st-block-positioner__inner'>","<span class='st-block-positioner__selected-value'></span>","<select class='st-block-positioner__select'></select>","</div>"].join("\n"),c=function(a,b){this.$block=a,this.instanceID=b,this.total_blocks=0,this._ensureElement(),this._bindFunctions(),this.initialize()};return b.extend(c.prototype,g,h,{bound:["onBlockCountChange","onSelectChange","toggle","show","hide"],className:"st-block-positioner",visibleClass:"st-block-positioner--is-visible",initialize:function(){this.$el.append(a),this.$select=this.$(".st-block-positioner__select"),this.$select.on("change",this.onSelectChange),d.EventBus.on(this.instanceID+":blocks:count_update",this.onBlockCountChange)},onBlockCountChange:function(a){a!=this.total_blocks&&(this.total_blocks=a,this.renderPositionList())},onSelectChange:function(){var a=this.$select.val();0!==a&&(d.EventBus.trigger(this.instanceID+":blocks:change_position",this.$block,a,1==a?"before":"after"),this.toggle())},renderPositionList:function(){for(var a="<option value='0'>"+i18n.t("general:position")+"</option>",b=1;b<=this.total_blocks;b++)a+="<option value="+b+">"+b+"</option>";this.$select.html(a)},toggle:function(){this.$select.val(0),this.$el.toggleClass(this.visibleClass)},show:function(){this.$el.addClass(this.visibleClass)},hide:function(){this.$el.removeClass(this.visibleClass)}}),c}(),d.BlockReorder=function(){var c=function(a){this.$block=a,this.blockID=this.$block.attr("id"),this._ensureElement(),this._bindFunctions(),this.initialize()};return b.extend(c.prototype,g,h,{bound:["onMouseDown","onClick","onDragStart","onDragEnd","onDrag","onDrop"],className:"st-block-ui-btn st-block-ui-btn--reorder st-icon",tagName:"a",attributes:function(){return{html:"reorder",draggable:"true","data-icon":"move"}},initialize:function(){this.$el.bind("mousedown touchstart",this.onMouseDown).bind("click",this.onClick).bind("dragstart",this.onDragStart).bind("dragend touchend",this.onDragEnd).bind("drag touchmove",this.onDrag),this.$block.dropArea().bind("drop",this.onDrop)},onMouseDown:function(){d.EventBus.trigger("block:reorder:down",this.blockID)},onDrop:function(c){c.preventDefault();var e=this.$block,f=c.originalEvent.dataTransfer.getData("text/plain"),g=a("#"+f);b.isUndefined(f)||b.isEmpty(g)||e.attr("id")==f||e.attr("data-instance")!=g.attr("data-instance")||e.after(g),d.EventBus.trigger("block:reorder:dropped",f)},onDragStart:function(b){var c=a(b.currentTarget).parent();b.originalEvent.dataTransfer.setDragImage(this.$block[0],c.position().left,c.position().top),b.originalEvent.dataTransfer.setData("Text",this.blockID),d.EventBus.trigger("block:reorder:dragstart",this.blockID),this.$block.addClass("st-block--dragging")},onDragEnd:function(){d.EventBus.trigger("block:reorder:dragend",this.blockID),this.$block.removeClass("st-block--dragging")},onDrag:function(){},onClick:function(){},render:function(){return this}}),c}(),d.BlockDeletion=function(){var a=function(){this._ensureElement(),this._bindFunctions()};return b.extend(a.prototype,g,h,{tagName:"a",className:"st-block-ui-btn st-block-ui-btn--delete st-icon",attributes:{html:"delete","data-icon":"bin"}}),a}();var l=function(a){var c=a.attr("data-st-name")||a.attr("name");return c||(c="Field"),b.capitalize(c)};d.BlockValidations={errors:[],valid:function(){return this.performValidations(),0===this.errors.length},performValidations:function(){this.resetErrors();var a=this.$(".st-required");b.each(a,this.validateField,this),b.each(this.validations,this.runValidator,this),this.$el.toggleClass("st-block--with-errors",this.errors.length>0)},validations:[],validateField:function(b){b=a(b);var c=b.attr("contenteditable")?b.text():b.val();0===c.length&&this.setError(b,i18n.t("errors:block_empty",{name:l(b)}))},runValidator:function(a){b.isUndefined(this[a])||this[a].call(this)},setError:function(a,b){var c=this.addMessage(b,"st-msg--error");a.addClass("st-error"),this.errors.push({field:a,reason:b,msg:c})},resetErrors:function(){b.each(this.errors,function(a){a.field.removeClass("st-error"),a.msg.remove()}),this.$messages.removeClass("st-block__messages--is-visible"),this.errors=[]}},d.BlockStore={blockStorage:{},createStore:function(a){this.blockStorage={type:b.underscored(this.type),data:a||{}}},save:function(){this.toData()},saveAndReturnData:function(){return this.save(),this.blockStorage},saveAndGetData:function(){var a=this.saveAndReturnData();return a.data||a},getData:function(){return this.blockStorage.data},setData:function(a){d.log("Setting data for block "+this.blockID),b.extend(this.blockStorage.data,a||{})},setAndRetrieveData:function(a){return this.setData(a),this.getData()},setAndLoadData:function(a){this.setData(a),this.beforeLoadingData()},toData:function(){},loadData:function(){},beforeLoadingData:function(){d.log("loadData for "+this.blockID),d.EventBus.trigger("block:loadData",this.blockID),this.loadData(this.getData())},_loadData:function(){d.log("_loadData is deprecated and will be removed in the future. Please use beforeLoadingData instead."),this.beforeLoadingData()},checkAndLoadData:function(){b.isEmpty(this.getData())||this.beforeLoadingData()}},d.SimpleBlock=function(){var c=function(a,c){this.createStore(a),this.blockID=b.uniqueId("st-block-"),this.instanceID=c,this._ensureElement(),this._bindFunctions(),this.initialize.apply(this,arguments)};return b.extend(c.prototype,g,d.Events,h,d.BlockStore,{focus:function(){},valid:function(){return!0},className:"st-block",block_template:b.template("<div class='st-block__inner'><%= editor_html %></div>"),attributes:function(){return{id:this.blockID,"data-type":this.type,"data-instance":this.instanceID}},title:function(){return b.titleize(this.type.replace(/[\W_]/g," "))},blockCSSClass:function(){return this.blockCSSClass=b.to_slug(this.type),this.blockCSSClass},type:"","class":function(){return b.classify(this.type)},editorHTML:"",initialize:function(){},onBlockRender:function(){},beforeBlockRender:function(){},_setBlockInner:function(){var a=b.result(this,"editorHTML");this.$el.append(this.block_template({editor_html:a})),this.$inner=this.$el.find(".st-block__inner"),this.$inner.bind("click mouseover",function(a){a.stopPropagation()})},render:function(){return this.beforeBlockRender(),this._setBlockInner(),this._blockPrepare(),this},_blockPrepare:function(){this._initUI(),this._initMessages(),this.checkAndLoadData(),this.$el.addClass("st-item-ready"),this.on("onRender",this.onBlockRender),this.save()},_withUIComponent:function(a,b,c){this.$ui.append(a.render().$el),b&&c&&this.$ui.on("click",b,c)},_initUI:function(){var b=a("<div>",{"class":"st-block__ui"});this.$inner.append(b),this.$ui=b,this._initUIComponents()},_initMessages:function(){var b=a("<div>",{"class":"st-block__messages"});this.$inner.prepend(b),this.$messages=b},addMessage:function(b,c){var d=a("<span>",{html:b,"class":"st-msg "+c});return this.$messages.append(d).addClass("st-block__messages--is-visible"),d},resetMessages:function(){this.$messages.html("").removeClass("st-block__messages--is-visible")},_initUIComponents:function(){this._withUIComponent(new d.BlockReorder(this.$el))}}),c.fn=c.prototype,c.extend=j,c}(),d.Block=function(){var c=function(){d.SimpleBlock.apply(this,arguments)},e=["<div class='st-block__ui-delete-controls'>","<label class='st-block__delete-label'>","<%= i18n.t('general:delete') %>","</label>","<a class='st-block-ui-btn st-block-ui-btn--confirm-delete st-icon' data-icon='tick'></a>","<a class='st-block-ui-btn st-block-ui-btn--deny-delete st-icon' data-icon='close'></a>","</div>"].join("\n"),f={html:['<div class="st-block__dropzone">','<span class="st-icon"><%= _.result(block, "icon_name") %></span>','<p><%= i18n.t("general:drop", { block: "<span>" + _.result(block, "title") + "</span>" }) %>',"</p></div>"].join("\n"),re_render_on_reorder:!1},g={html:['<input type="text" placeholder="<%= i18n.t("general:paste") %>"',' class="st-block__paste-input st-paste-block">'].join("")},h={html:['<div class="st-block__upload-container">','<input type="file" type="st-file-upload">','<button class="st-upload-btn"><%= i18n.t("general:upload") %></button>',"</div>"].join("\n")};return d.DEFAULTS.Block={drop_options:f,paste_options:g,upload_options:h},b.extend(c.prototype,d.SimpleBlock.fn,d.BlockValidations,{bound:["_handleContentPaste","_onFocus","_onBlur","onDrop","onDeleteClick","clearInsertedStyles","getSelectionForFormatter","onBlockRender"],className:"st-block st-icon--add",attributes:function(){return b.extend(d.SimpleBlock.fn.attributes.call(this),{"data-icon-after":"add"})},icon_name:"default",validationFailMsg:function(){return i18n.t("errors:validation_fail",{type:this.title()})},editorHTML:'<div class="st-block__editor"></div>',toolbarEnabled:!0,droppable:!1,pastable:!1,uploadable:!1,fetchable:!1,ajaxable:!1,drop_options:{},paste_options:{},upload_options:{},formattable:!0,_previousSelection:"",initialize:function(){},toMarkdown:function(a){return a},toHTML:function(a){return a},withMixin:function(a){if(b.isObject(a)){var c="initialize"+a.mixinName;b.isUndefined(this[c])&&(b.extend(this,a),this[c]())}},render:function(){if(this.beforeBlockRender(),this._setBlockInner(),this.$editor=this.$inner.children().first(),this.droppable||this.pastable||this.uploadable){var b=a("<div>",{"class":"st-block__inputs"});this.$inner.append(b),this.$inputs=b}return this.hasTextBlock&&this._initTextBlocks(),this.droppable&&this.withMixin(d.BlockMixins.Droppable),this.pastable&&this.withMixin(d.BlockMixins.Pastable),this.uploadable&&this.withMixin(d.BlockMixins.Uploadable),this.fetchable&&this.withMixin(d.BlockMixins.Fetchable),this.controllable&&this.withMixin(d.BlockMixins.Controllable),this.formattable&&this._initFormatting(),this._blockPrepare(),this},remove:function(){this.ajaxable&&this.resolveAllInQueue(),this.$el.remove()},loading:function(){b.isUndefined(this.spinner)||this.ready(),this.spinner=new Spinner(d.DEFAULTS.spinner),this.spinner.spin(this.$el[0]),this.$el.addClass("st--is-loading")},ready:function(){this.$el.removeClass("st--is-loading"),b.isUndefined(this.spinner)||(this.spinner.stop(),delete this.spinner)},toData:function(){d.log("toData for "+this.blockID);var c=(this.$el,{});if(this.hasTextBlock()){var e=this.getTextBlock().html();e.length>0&&(c.text=d.toMarkdown(e,this.type))}this.$(":input").not(".st-paste-block").length>0&&this.$(":input").each(function(a,b){b.getAttribute("name")&&(c[b.getAttribute("name")]=b.value)}),b.isEmpty(c)||this.setData(c)},focus:function(){this.getTextBlock().focus()},blur:function(){this.getTextBlock().blur()},onFocus:function(){this.getTextBlock().bind("focus",this._onFocus)},onBlur:function(){this.getTextBlock().bind("blur",this._onBlur)},_onFocus:function(){this.trigger("blockFocus",this.$el)},_onBlur:function(){},onDrop:function(){},onDeleteClick:function(a){a.preventDefault();var c=function(a){a.preventDefault(),this.trigger("removeBlock",this.blockID)},d=function(a){a.preventDefault(),this.$el.removeClass("st-block--delete-active"),f.remove()};if(this.isEmpty())return c.call(this,new Event("click")),void 0;this.$inner.append(b.template(e)),this.$el.addClass("st-block--delete-active");var f=this.$inner.find(".st-block__ui-delete-controls");this.$inner.on("click",".st-block-ui-btn--confirm-delete",b.bind(c,this)).on("click",".st-block-ui-btn--deny-delete",b.bind(d,this))},pastedMarkdownToHTML:function(a){return d.toHTML(d.toMarkdown(a,this.type),this.type)},onContentPasted:function(a,b){b.html(this.pastedMarkdownToHTML(b[0].innerHTML)),this.getTextBlock().caretToEnd()},beforeLoadingData:function(){this.loading(),(this.droppable||this.uploadable||this.pastable)&&(this.$editor.show(),this.$inputs.hide()),d.SimpleBlock.fn.beforeLoadingData.call(this),this.ready()},_handleContentPaste:function(c){var d=a(c.currentTarget);b.delay(b.bind(this.onContentPasted,this,c,d),0)},_getBlockClass:function(){return"st-block--"+this.className},_initUIComponents:function(){var a=new d.BlockPositioner(this.$el,this.instanceID);this._withUIComponent(a,".st-block-ui-btn--reorder",a.toggle),this._withUIComponent(new d.BlockReorder(this.$el)),this._withUIComponent(new d.BlockDeletion,".st-block-ui-btn--delete",this.onDeleteClick),this.onFocus(),this.onBlur()},_initFormatting:function(){var a;for(var c in d.Formatters)d.Formatters.hasOwnProperty(c)&&(a=d.Formatters[c],b.isUndefined(a.keyCode)||a._bindToBlock(this.$el))},_initTextBlocks:function(){this.getTextBlock().bind("paste",this._handleContentPaste).bind("keyup",this.getSelectionForFormatter).bind("mouseup",this.getSelectionForFormatter).bind("DOMNodeInserted",this.clearInsertedStyles)},getSelectionForFormatter:function(){b.defer(function(a){var b=window.getSelection(),c=b.toString().trim(),e=""===c?"hide":"position";d.EventBus.trigger("formatter:"+e,a)},this)},clearInsertedStyles:function(a){var b=a.target;b.removeAttribute("style")},hasTextBlock:function(){return this.getTextBlock().length>0},getTextBlock:function(){return b.isUndefined(this.text_block)&&(this.text_block=this.$(".st-text-block")),this.text_block},isEmpty:function(){return b.isEmpty(this.saveAndGetData())}}),c.extend=j,c}(),d.Formatter=function(){var a=function(a){this.formatId=b.uniqueId("format-"),this._configure(a||{}),this.initialize.apply(this,arguments)},c=["title","className","cmd","keyCode","param","onClick","toMarkdown","toHTML"];return b.extend(a.prototype,{title:"",className:"",cmd:null,keyCode:null,param:null,toMarkdown:function(a){return a},toHTML:function(a){return a},initialize:function(){},_configure:function(a){this.options&&(a=b.extend({},this.options,a));for(var d=0,e=c.length;e>d;d++){var f=c[d];a[f]&&(this[f]=a[f])}this.options=a},isActive:function(){return document.queryCommandState(this.cmd)},_bindToBlock:function(a){var b=this,c=!1;a.on("keyup",".st-text-block",function(a){(17==a.which||224==a.which||91==a.which)&&(c=!1)}).on("keydown",".st-text-block",{formatter:b},function(a){(17==a.which||224==a.which||91==a.which)&&(c=!0),a.which==a.data.formatter.keyCode&&c===!0&&(document.execCommand(a.data.formatter.cmd,!1,!0),a.preventDefault(),c=!1)
})}}),a.extend=j,a}(),d.Blocks.Quote=function(){var a=b.template(['<blockquote class="st-required st-text-block" contenteditable="true"></blockquote>','<label class="st-input-label"> <%= i18n.t("blocks:quote:credit_field") %></label>','<input maxlength="140" name="cite" placeholder="<%= i18n.t("blocks:quote:credit_field") %>"',' class="st-input-string st-required js-cite-input" type="text" />'].join("\n"));return d.Block.extend({type:"quote",title:function(){return i18n.t("blocks:quote:title")},icon_name:"quote",editorHTML:function(){return a(this)},loadData:function(a){this.getTextBlock().html(d.toHTML(a.text,this.type)),this.$(".js-cite-input").val(a.cite)},toMarkdown:function(a){return a.replace(/^(.+)$/gm,"> $1")}})}(),d.Blocks.Heading=d.Block.extend({type:"Heading",title:function(){return i18n.t("blocks:heading:title")},editorHTML:'<div class="st-required st-text-block st-text-block--heading" contenteditable="true"></div>',icon_name:"heading",loadData:function(a){this.getTextBlock().html(d.toHTML(a.text,this.type))}}),d.Blocks.Image=d.Block.extend({type:"image",title:function(){return i18n.t("blocks:image:title")},droppable:!0,uploadable:!0,icon_name:"image",loadData:function(b){this.$editor.html(a("<img>",{src:b.file.url}))},onBlockRender:function(){this.$inputs.find("button").bind("click",function(a){a.preventDefault()}),this.$inputs.find("input").on("change",b.bind(function(a){this.onDrop(a.currentTarget)},this))},onUploadSuccess:function(a){this.setData(a),this.ready()},onUploadError:function(){this.addMessage(i18n.t("blocks:image:upload_error")),this.ready()},onDrop:function(b){var c=b.files[0],d="undefined"!=typeof URL?URL:"undefined"!=typeof webkitURL?webkitURL:null;/image/.test(c.type)&&(this.loading(),this.$inputs.hide(),this.$editor.html(a("<img>",{src:d.createObjectURL(c)})).show(),this.uploader(c,this.onUploadSuccess,this.onUploadError))}}),d.Blocks.Text=d.Block.extend({type:"text",title:function(){return i18n.t("blocks:text:title")},editorHTML:'<div class="st-required st-text-block" contenteditable="true"></div>',icon_name:"text",loadData:function(a){this.getTextBlock().html(d.toHTML(a.text,this.type))}}),d.Blocks.Tweet=function(){var c=b.template(["<blockquote class='twitter-tweet' align='center'>","<p><%= text %></p>","&mdash; <%= user.name %> (@<%= user.screen_name %>)","<a href='<%= status_url %>' data-datetime='<%= created_at %>'><%= created_at %></a>","</blockquote>",'<script src="//platform.twitter.com/widgets.js" charset="utf-8"></script>'].join("\n"));return d.Block.extend({type:"tweet",droppable:!0,pastable:!0,fetchable:!0,drop_options:{re_render_on_reorder:!0},title:function(){return i18n.t("blocks:tweet:title")},fetchUrl:function(a){return"/tweets/?tweet_id="+a},icon_name:"twitter",loadData:function(a){b.isUndefined(a.status_url)&&(a.status_url=""),this.$inner.find("iframe").remove(),this.$inner.prepend(c(a))},onContentPasted:function(b){var c=a(b.target),d=c.val();this.handleTwitterDropPaste(d)},handleTwitterDropPaste:function(a){if(!this.validTweetUrl(a))return d.log("Invalid Tweet URL"),void 0;var c=a.match(/[^\/]+$/);if(!b.isEmpty(c)){this.loading(),c=c[0];var e={url:this.fetchUrl(c),dataType:"json"};this.fetch(e,this.onTweetSuccess,this.onTweetFail)}},validTweetUrl:function(a){return b.isURI(a)&&-1!==a.indexOf("twitter")&&-1!==a.indexOf("status")},onTweetSuccess:function(a){var b={user:{profile_image_url:a.user.profile_image_url,profile_image_url_https:a.user.profile_image_url_https,screen_name:a.user.screen_name,name:a.user.name},id:a.id_str,text:a.text,created_at:a.created_at,entities:a.entities,status_url:"https://twitter.com/"+a.user.screen_name+"/status/"+a.id_str};this.setAndLoadData(b),this.ready()},onTweetFail:function(){this.addMessage(i18n.t("blocks:tweet:fetch_error")),this.ready()},onDrop:function(a){var b=a.getData("text/plain");this.handleTwitterDropPaste(b)}})}(),d.Blocks.List=function(){var a='<div class="st-text-block st-required" contenteditable="true"><ul><li></li></ul></div>';return d.Block.extend({type:"list",title:function(){return i18n.t("blocks:list:title")},icon_name:"list",editorHTML:function(){return b.template(a,this)},loadData:function(a){this.getTextBlock().html("<ul>"+d.toHTML(a.text,this.type)+"</ul>")},onBlockRender:function(){this.checkForList=b.bind(this.checkForList,this),this.getTextBlock().on("click keyup",this.checkForList)},checkForList:function(){0===this.$("ul").length&&document.execCommand("insertUnorderedList",!1,!1)},toMarkdown:function(a){return a.replace(/<\/li>/gm,"\n").replace(/<\/?[^>]+(>|$)/g,"").replace(/^(.+)$/gm," - $1")},toHTML:function(a){return a=a.replace(/^ - (.+)$/gm,"<li>$1</li>").replace(/\n/gm,"")},onContentPasted:function(a,b){var c=this.pastedMarkdownToHTML(b[0].innerHTML);this.$("ul").html(c),this.getTextBlock().caretToEnd()},isEmpty:function(){return b.isEmpty(this.saveAndGetData().text)}})}(),d.Blocks.Video=function(){return d.Block.extend({providers:{vimeo:{regex:/(?:http[s]?:\/\/)?(?:www.)?vimeo.com\/(.+)/,html:'<iframe src="{{protocol}}//player.vimeo.com/video/{{remote_id}}?title=0&byline=0" width="580" height="320" frameborder="0"></iframe>'},youtube:{regex:/(?:http[s]?:\/\/)?(?:www.)?(?:(?:youtube.com\/watch\?(?:.*)(?:v=))|(?:youtu.be\/))([^&].+)/,html:'<iframe src="{{protocol}}//www.youtube.com/embed/{{remote_id}}" width="580" height="320" frameborder="0" allowfullscreen></iframe>'}},type:"video",title:function(){return i18n.t("blocks:video:title")},droppable:!0,pastable:!0,icon_name:"video",loadData:function(a){if(this.providers.hasOwnProperty(a.source)){this.providers[a.source].square?this.$editor.addClass("st-block__editor--with-square-media"):this.$editor.addClass("st-block__editor--with-sixteen-by-nine-media");var b=this.providers[a.source].html.replace("{{protocol}}",window.location.protocol).replace("{{remote_id}}",a.remote_id).replace("{{width}}",this.$editor.width());this.$editor.html(b)}},onContentPasted:function(b){this.handleDropPaste(a(b.target).val())},handleDropPaste:function(a){if(b.isURI(a)){var c,d;b.each(this.providers,function(e,f){c=e.regex.exec(a),null===c||b.isUndefined(c[1])||(d={source:f,remote_id:c[1]},this.setAndLoadData(d))},this)}},onDrop:function(a){var b=a.getData("text/plain");this.handleDropPaste(b)}})}(),function(){var a=d.Formatter.extend({title:"bold",cmd:"bold",keyCode:66,text:"B"}),b=d.Formatter.extend({title:"italic",cmd:"italic",keyCode:73,text:"i"}),c=d.Formatter.extend({title:"link",iconName:"link",cmd:"CreateLink",text:"link",onClick:function(){var a=prompt(i18n.t("general:link")),b=/((ftp|http|https):\/\/.)|mailto(?=\:[-\.\w]+@)/;a&&a.length>0&&(b.test(a)||(a="http://"+a),document.execCommand(this.cmd,!1,a))},isActive:function(){var b,a=window.getSelection();return a.rangeCount>0&&(b=a.getRangeAt(0).startContainer.parentNode),b&&"A"==b.nodeName}}),e=d.Formatter.extend({title:"unlink",iconName:"link",cmd:"unlink",text:"link"});d.Formatters.Bold=new a,d.Formatters.Italic=new b,d.Formatters.Link=new c,d.Formatters.Unlink=new e}(),d.BlockControl=function(){var a=function(a,b){this.type=a,this.instance_scope=b,this.block_type=d.Blocks[this.type].prototype,this.can_be_rendered=this.block_type.toolbarEnabled,this._ensureElement()};return b.extend(a.prototype,g,h,d.Events,{tagName:"a",className:"st-block-control",attributes:function(){return{"data-type":this.block_type.type}},render:function(){return this.$el.html('<span class="st-icon">'+b.result(this.block_type,"icon_name")+"</span>"+b.result(this.block_type,"title")),this}}),a}(),d.BlockControls=function(){var c=function(a,b){this.instance_scope=b,this.available_types=a||[],this._ensureElement(),this._bindFunctions(),this.initialize()};return b.extend(c.prototype,g,h,d.Events,{bound:["handleControlButtonClick"],block_controls:null,className:"st-block-controls",html:"<a class='st-icon st-icon--close'>"+i18n.t("general:close")+"</a>",initialize:function(){for(var a in this.available_types)if(d.Blocks.hasOwnProperty(a)){var b=new d.BlockControl(a,this.instance_scope);b.can_be_rendered&&this.$el.append(b.render().$el)}this.$el.delegate(".st-block-control","click",this.handleControlButtonClick)},show:function(){this.$el.addClass("st-block-controls--active"),d.EventBus.trigger("block:controls:shown")},hide:function(){this.$el.removeClass("st-block-controls--active"),d.EventBus.trigger("block:controls:hidden")},handleControlButtonClick:function(b){b.stopPropagation(),this.trigger("createBlock",a(b.currentTarget).attr("data-type"))}}),c}(),d.FloatingBlockControls=function(){var c=function(a,b){this.$wrapper=a,this.instance_id=b,this._ensureElement(),this._bindFunctions(),this.initialize()};return b.extend(c.prototype,g,h,d.Events,{className:"st-block-controls__top",attributes:function(){return{"data-icon":"add"}},bound:["handleBlockMouseOut","handleBlockMouseOver","handleBlockClick","onDrop"],initialize:function(){this.$el.on("click",this.handleBlockClick).dropArea().bind("drop",this.onDrop),this.$wrapper.on("mouseover",".st-block",this.handleBlockMouseOver).on("mouseout",".st-block",this.handleBlockMouseOut).on("click",".st-block--with-plus",this.handleBlockClick)},onDrop:function(c){c.preventDefault();var e=this.$el,f=c.originalEvent.dataTransfer.getData("text/plain"),g=a("#"+f);b.isUndefined(f)||b.isEmpty(g)||e.attr("id")==f||this.instance_id!=g.attr("data-instance")||e.after(g),d.EventBus.trigger("block:reorder:dropped",f)},handleBlockMouseOver:function(b){var c=a(b.currentTarget);c.hasClass("st-block--with-plus")||c.addClass("st-block--with-plus")},handleBlockMouseOut:function(b){var c=a(b.currentTarget);c.hasClass("st-block--with-plus")&&c.removeClass("st-block--with-plus")},handleBlockClick:function(b){b.stopPropagation();var c=a(b.currentTarget);this.trigger("showBlockControls",c)}}),c}(),d.FormatBar=function(){var c=function(a){this.options=b.extend({},d.DEFAULTS.formatBar,a||{}),this._ensureElement(),this._bindFunctions(),this.initialize.apply(this,arguments)};return b.extend(c.prototype,g,d.Events,h,{className:"st-format-bar",bound:["onFormatButtonClick","renderBySelection","hide"],initialize:function(){var b,c,e;this.$btns=[];for(b in d.Formatters)d.Formatters.hasOwnProperty(b)&&(c=d.Formatters[b],e=a("<button>",{"class":"st-format-btn st-format-btn--"+b+" "+(c.iconName?"st-icon":""),text:c.text,"data-type":b,"data-cmd":c.cmd}),this.$btns.push(e),e.appendTo(this.$el));this.$b=a(document),this.$el.bind("click",".st-format-btn",this.onFormatButtonClick)},hide:function(){this.$el.removeClass("st-format-bar--is-ready")},show:function(){this.$el.addClass("st-format-bar--is-ready")},remove:function(){this.$el.remove()},renderBySelection:function(){var b=window.getSelection(),c=b.getRangeAt(0),d=c.getBoundingClientRect(),e={};e.top=d.top+20+window.pageYOffset-this.$el.height()+"px",e.left=(d.left+d.right)/2-this.$el.width()/2+"px",this.highlightSelectedButtons(),this.show(),this.$el.css(e)},highlightSelectedButtons:function(){var a;b.each(this.$btns,function(b){a=d.Formatters[b.attr("data-type")],b.toggleClass("st-format-btn--is-active",a.isActive())},this)},onFormatButtonClick:function(c){c.stopPropagation();var e=a(c.target),f=d.Formatters[e.attr("data-type")];return b.isUndefined(f)?!1:(!b.isUndefined(f.onClick)&&b.isFunction(f.onClick)?f.onClick():document.execCommand(e.attr("data-cmd"),!1,f.param),this.highlightSelectedButtons(),!1)}}),c}(),d.Editor=function(){var c=function(a){this.initialize(a)};return b.extend(c.prototype,g,d.Events,{bound:["onFormSubmit","showBlockControls","hideAllTheThings","hideBlockControls","onNewBlockCreated","changeBlockPosition","onBlockDragStart","onBlockDragEnd","removeBlockDragOver","onBlockDropped","createBlock"],events:{"block:reorder:down":"hideBlockControls","block:reorder:dragstart":"onBlockDragStart","block:reorder:dragend":"onBlockDragEnd","block:content:dropped":"removeBlockDragOver","block:reorder:dropped":"onBlockDropped","block:create:new":"onNewBlockCreated"},initialize:function(a){return d.log("Init SirTrevor.Editor"),this.blockTypes={},this.blockCounts={},this.blocks=[],this.errors=[],this.options=b.extend({},d.DEFAULTS,a||{}),this.ID=b.uniqueId("st-editor-"),this._ensureAndSetElements()?(!b.isUndefined(this.options.onEditorRender)&&b.isFunction(this.options.onEditorRender)&&(this.onEditorRender=this.options.onEditorRender),this._setRequired(),this._setBlocksTypes(),this._bindFunctions(),this.store("create"),d.instances.push(this),this.build(),d.bindFormSubmit(this.$form),void 0):!1},build:function(){this.$el.hide(),this.block_controls=new d.BlockControls(this.blockTypes,this.ID),this.fl_block_controls=new d.FloatingBlockControls(this.$wrapper,this.ID),this.formatBar=new d.FormatBar(this.options.formatBar),this.listenTo(this.block_controls,"createBlock",this.createBlock),this.listenTo(this.fl_block_controls,"showBlockControls",this.showBlockControls),this._setEvents(),d.EventBus.on(this.ID+":blocks:change_position",this.changeBlockPosition),d.EventBus.on("formatter:position",this.formatBar.renderBySelection),d.EventBus.on("formatter:hide",this.formatBar.hide),this.$wrapper.prepend(this.fl_block_controls.render().$el),a(document.body).append(this.formatBar.render().$el),this.$outer.append(this.block_controls.render().$el),a(window).bind("click.sirtrevor",this.hideAllTheThings);var c=this.store("read");c.data.length>0?b.each(c.data,function(a){d.log("Creating: "+a.type),this.createBlock(a.type,a.data)},this):this.options.defaultType!==!1&&this.createBlock(this.options.defaultType,{}),this.$wrapper.addClass("st-ready"),b.isUndefined(this.onEditorRender)||this.onEditorRender()},destroy:function(){this.formatBar.destroy(),this.fl_block_controls.destroy(),this.block_controls.destroy(),b.each(this.blocks,function(a){this.removeBlock(a.blockID)},this),this.stopListening();var a=this.$el.detach();d.instances=b.reject(d.instances,b.bind(function(a){return a.ID==this.ID},this)),this.store("reset"),this.$outer.replaceWith(a)},reinitialize:function(a){this.destroy(),this.initialize(a||this.options)},_setEvents:function(){b.each(this.events,function(a,b){d.EventBus.on(b,this[a],this)},this)},hideAllTheThings:function(){this.block_controls.hide(),this.formatBar.hide(),b.isUndefined(this.block_controls.current_container)||this.block_controls.current_container.removeClass("with-st-controls")},showBlockControls:function(a){b.isUndefined(this.block_controls.current_container)||this.block_controls.current_container.removeClass("with-st-controls"),this.block_controls.show(),a.append(this.block_controls.$el.detach()),a.addClass("with-st-controls"),this.block_controls.current_container=a},store:function(a,b){return d.editorStore(this,a,b||{})},createBlock:function(a,c){if(a=b.classify(a),this._blockLimitReached())return d.log("Cannot add any more blocks. Limit reached."),!1;if(!this._isBlockTypeAvailable(a))return d.log("Block type not available "+a),!1;if(!this._canAddBlockType(a))return d.log("Block Limit reached for type "+a),!1;var f=new d.Blocks[a](c,this.ID);this._renderInPosition(f.render().$el),this.listenTo(f,"removeBlock",this.removeBlock),this.blocks.push(f),this._incrementBlockTypeCount(a),f.focus(),d.EventBus.trigger(c?"block:create:existing":"block:create:new",f),d.log("Block created of type "+a),f.trigger("onRender"),this.$wrapper.toggleClass("st--block-limit-reached",this._blockLimitReached()),this.triggerBlockCountUpdate()},onNewBlockCreated:function(a){this.hideBlockControls(),this.scrollTo(a.$el)},scrollTo:function(b){a("html, body").animate({scrollTop:b.position().top},300,"linear")},blockFocus:function(){this.block_controls.current_container=null},hideBlockControls:function(){b.isUndefined(this.block_controls.current_container)||this.block_controls.current_container.removeClass("with-st-controls"),this.block_controls.hide()},removeBlockDragOver:function(){this.$outer.find(".st-drag-over").removeClass("st-drag-over")},triggerBlockCountUpdate:function(){d.EventBus.trigger(this.ID+":blocks:count_update",this.blocks.length)},changeBlockPosition:function(a,b){b-=1;var c=this.getBlockPosition(a),d=this.$wrapper.find(".st-block").eq(b);this.getBlockPosition(d);var f=c>b?"Before":"After";d&&d.attr("id")!==a.attr("id")&&(this.hideAllTheThings(),a["insert"+f](d),this.scrollTo(a))},onBlockDropped:function(a){this.hideAllTheThings();var c=this.findBlockById(a);b.isUndefined(c)||b.isEmpty(c.getData())||!c.drop_options.re_render_on_reorder||c.beforeLoadingData()},onBlockDragStart:function(){this.hideBlockControls(),this.$wrapper.addClass("st-outer--is-reordering")},onBlockDragEnd:function(){this.removeBlockDragOver(),this.$wrapper.removeClass("st-outer--is-reordering")},_renderInPosition:function(a){this.block_controls.current_container?this.block_controls.current_container.after(a):this.$wrapper.append(a)},_incrementBlockTypeCount:function(a){this.blockCounts[a]=b.isUndefined(this.blockCounts[a])?1:this.blockCounts[a]+1},_getBlockTypeCount:function(a){return b.isUndefined(this.blockCounts[a])?0:this.blockCounts[a]},_canAddBlockType:function(a){var b=this._getBlockTypeLimit(a);return!(0!==b&&this._getBlockTypeCount(a)>=b)},_blockLimitReached:function(){return 0!==this.options.blockLimit&&this.blocks.length>=this.options.blockLimit},removeBlock:function(a){var c=this.findBlockById(a),e=b.classify(c.type),f=c.$el.find(".st-block-controls");f.length&&(this.block_controls.hide(),this.$wrapper.prepend(f)),this.blockCounts[e]=this.blockCounts[e]-1,this.blocks=b.reject(this.blocks,function(a){return a.blockID==c.blockID}),this.stopListening(c),c.remove(),d.EventBus.trigger("block:remove",c),this.triggerBlockCountUpdate(),this.$wrapper.toggleClass("st--block-limit-reached",this._blockLimitReached())},performValidations:function(a,c){var e=0;return!d.SKIP_VALIDATION&&c&&(a.valid()||(this.errors.push({text:b.result(a,"validationFailMsg")}),d.log("Block "+a.blockID+" failed validation"),++e)),e},saveBlockStateToStore:function(a){var c=a.saveAndReturnData();c&&!b.isEmpty(c.data)&&(d.log("Adding data for block "+a.blockID+" to block store"),this.store("add",{data:c}))},onFormSubmit:function(a){return a=a===!1?!1:!0,d.log("Handling form submission for Editor "+this.ID),this.removeErrors(),this.store("reset"),this.validateBlocks(a),this.validateBlockTypesExist(a),this.renderErrors(),this.store("save"),this.errors.length},validateBlocks:function(c){if(!this.required&&d.SKIP_VALIDATION&&!c)return!1;var e=function(d){var f=b.find(this.blocks,function(b){return b.blockID==a(d).attr("id")});return b.isUndefined(f)?!1:(this.performValidations(f,c),this.saveBlockStateToStore(f),void 0)};b.each(this.$wrapper.find(".st-block"),e,this)},validateBlockTypesExist:function(a){if(!this.required&&d.SKIP_VALIDATION&&!a)return!1;var c=function(a){if(this._isBlockTypeAvailable(a))if(0===this._getBlockTypeCount(a))d.log("Failed validation on required block type "+a),this.errors.push({text:i18n.t("errors:type_missing",{type:a})});else{var e=b.filter(this.getBlocksByType(a),function(a){return!a.isEmpty()});if(e.length>0)return!1;this.errors.push({text:i18n.t("errors:required_type_empty",{type:a})}),d.log("A required block type "+a+" is empty")}};b.isArray(this.required)&&b.each(this.required,c,this)},renderErrors:function(){if(0===this.errors.length)return!1;b.isUndefined(this.$errors)&&(this.$errors=this._errorsContainer());var a="<ul>";b.each(this.errors,function(b){a+='<li class="st-errors__msg">'+b.text+"</li>"}),a+="</ul>",this.$errors.append(a),this.$errors.show()},_errorsContainer:function(){if(b.isUndefined(this.options.errorsContainer)){var c=a("<div>",{"class":"st-errors",html:"<p>"+i18n.t("errors:title")+" </p>"});return this.$outer.prepend(c),c}return e(this.options.errorsContainer)},removeErrors:function(){return 0===this.errors.length?!1:(this.$errors.hide().find("ul").html(""),this.errors=[],void 0)},findBlockById:function(a){return b.find(this.blocks,function(b){return b.blockID==a})},getBlocksByType:function(a){return b.filter(this.blocks,function(c){return b.classify(c.type)==a})},getBlocksByIDs:function(a){return b.filter(this.blocks,function(c){return b.contains(a,c.blockID)})},getBlockPosition:function(a){return this.$wrapper.find(".st-block").index(a)},_getBlockTypeLimit:function(a){return this._isBlockTypeAvailable(a)?parseInt(b.isUndefined(this.options.blockTypeLimits[a])?0:this.options.blockTypeLimits[a],10):0},_isBlockTypeAvailable:function(a){return!b.isUndefined(this.blockTypes[a])},_ensureAndSetElements:function(){if(b.isUndefined(this.options.el)||b.isEmpty(this.options.el))return d.log("You must provide an el"),!1;this.$el=this.options.el,this.el=this.options.el[0],this.$form=this.$el.parents("form");var c=a("<div>").attr({id:this.ID,"class":"st-outer",dropzone:"copy link move"}),e=a("<div>").attr({"class":"st-blocks"});return this.$el.wrap(c).wrap(e),this.$outer=this.$form.find("#"+this.ID),this.$wrapper=this.$outer.find(".st-blocks"),!0},_setBlocksTypes:function(){this.blockTypes=b.flattern(b.isUndefined(this.options.blockTypes)?d.Blocks:this.options.blockTypes)},_setRequired:function(){this.required=b.isArray(this.options.required)&&!b.isEmpty(this.options.required)?this.options.required:!1}}),c}(),d.setDefaults=function(a){d.DEFAULTS=b.extend(d.DEFAULTS,a||{})},d.bindFormSubmit=function(a){f||(new d.Submittable(a),a.on("submit.sirtrevor",this.onFormSubmit),f=!0)},d.onBeforeSubmit=function(a){var c=0;return b.each(d.instances,function(b){c+=b.onFormSubmit(a)}),d.log("Total errors: "+c),c},d.onFormSubmit=function(a){var b=d.onBeforeSubmit();b>0&&(d.EventBus.trigger("onError"),a.preventDefault())},d.getInstance=function(a){return b.isUndefined(a)?this.instances[0]:b.isString(a)?b.find(this.instances,function(b){return b.ID===a}):this.instances[a]},d.setBlockOptions=function(a,c){var e=d.Blocks[a];b.isUndefined(e)||b.extend(e.prototype,c||{})},d.runOnAllInstances=function(a){b.has(d.Editor.prototype,a)?([].unshift.call(arguments,d.instances),b.invoke.apply(b,arguments)):d.log("method doesn't exist")}}(jQuery,_);

